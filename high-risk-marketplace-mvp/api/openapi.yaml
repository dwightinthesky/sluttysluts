openapi: 3.1.0
info:
  title: High-Risk Marketplace API
  version: 0.3.0
  description: |
    Compliance-first marketplace API draft with promotion, wallet, chat, and hosted checkout webhook flows.
servers:
  - url: https://api.example.com
security:
  - bearerAuth: []

paths:
  /v1/age/verify:
    post:
      summary: Start buyer age verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [userId, provider]
              properties:
                userId:
                  type: string
                provider:
                  type: string
      responses:
        "202":
          description: Verification started

  /v1/sellers/kyc:
    post:
      summary: Submit seller KYC/KYB data pointer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sellerId, providerCaseId]
              properties:
                sellerId:
                  type: string
                providerCaseId:
                  type: string
                provider:
                  type: string
      responses:
        "202":
          description: KYC submitted

  /v1/listings:
    post:
      summary: Create listing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateListingRequest'
      responses:
        "201":
          description: Listing created
    get:
      summary: Search and rank listings for explore page
      parameters:
        - in: query
          name: q
          schema:
            type: string
        - in: query
          name: minPrice
          schema:
            type: number
        - in: query
          name: maxPrice
          schema:
            type: number
        - in: query
          name: status
          schema:
            type: string
            default: active
      responses:
        "200":
          description: Listing results

  /v1/orders:
    post:
      summary: Create pending order with fee breakdown and hosted checkout session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrderRequest'
      responses:
        "201":
          description: Order created

  /v1/payments/webhooks/high-risk:
    post:
      summary: Receive async hosted-checkout webhook callback
      parameters:
        - in: header
          name: x-webhook-token
          required: true
          schema:
            type: string
        - in: header
          name: x-webhook-timestamp
          required: false
          schema:
            oneOf:
              - type: integer
              - type: string
          description: Optional event timestamp for replay-window validation (unix seconds/ms or ISO-8601)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentWebhookRequest'
      responses:
        "200":
          description: Duplicate webhook ignored
        "202":
          description: Webhook processed or ignored due to state mismatch
        "400":
          description: Invalid payload or stale/future webhook timestamp
        "409":
          description: Event ID conflict with different payload hash

  /v1/orders/{orderId}/delivery-confirmation:
    post:
      summary: Confirm delivery and release payout eligibility
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Delivery confirmed

  /v1/orders/{orderId}/shipping-proof:
    post:
      summary: Attach shipping proof for dispute evidence package
      parameters:
        - in: path
          name: orderId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ShippingProofRequest'
      responses:
        "202":
          description: Shipping proof updated

  /v1/disputes:
    get:
      summary: List disputes visible to current actor
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: orderId
          schema:
            type: string
      responses:
        "200":
          description: Dispute list
    post:
      summary: Open dispute
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDisputeRequest'
      responses:
        "201":
          description: Dispute created

  /v1/disputes/{disputeId}/resolve:
    post:
      summary: Resolve dispute as seller_won or seller_lost (admin/ops)
      parameters:
        - in: path
          name: disputeId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResolveDisputeRequest'
      responses:
        "202":
          description: Dispute resolved

  /v1/disputes/{disputeId}/evidence-packet:
    get:
      summary: Build evidence packet for chargeback/dispute response
      parameters:
        - in: path
          name: disputeId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Evidence packet

  /v1/payouts/release:
    post:
      summary: Release eligible seller balances
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                force:
                  type: boolean
                  default: false
      responses:
        "202":
          description: Payout job started

  /v1/ops/moderation/queue:
    get:
      summary: List pending listings for manual moderation queue
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 24
      responses:
        "200":
          description: Moderation queue snapshot

  /v1/ops/moderation/listings/{listingId}/decision:
    post:
      summary: Approve or reject a pending listing moderation case
      parameters:
        - in: path
          name: listingId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModerationDecisionRequest'
      responses:
        "202":
          description: Moderation decision applied

  /v1/promotions/plans:
    get:
      summary: List promotion plans
      responses:
        "200":
          description: Available promotion plans

  /v1/promotions/purchase:
    post:
      summary: Purchase a promotion plan for a listing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchasePromotionRequest'
      responses:
        "201":
          description: Promotion purchased

  /v1/sellers/{sellerId}/promotions:
    get:
      summary: List seller promotion campaigns and summary
      parameters:
        - in: path
          name: sellerId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Seller promotions

  /v1/promotions/{promotionId}/consume-click:
    post:
      summary: Consume one click from click-based promotion
      parameters:
        - in: path
          name: promotionId
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Click consumed

  /v1/wallets/{sellerId}/summary:
    get:
      summary: Get seller wallet balances
      parameters:
        - in: path
          name: sellerId
          required: true
          schema:
            type: string
        - in: query
          name: currency
          schema:
            type: string
            default: USD
      responses:
        "200":
          description: Wallet summary

  /v1/wallets/{sellerId}/ledger:
    get:
      summary: Get seller wallet ledger entries (append-only style view)
      parameters:
        - in: path
          name: sellerId
          required: true
          schema:
            type: string
        - in: query
          name: currency
          schema:
            type: string
            default: USD
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
      responses:
        "200":
          description: Wallet ledger list

  /v1/wallets/{sellerId}/withdrawals:
    post:
      summary: Request a seller withdrawal
      parameters:
        - in: path
          name: sellerId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWithdrawalRequest'
      responses:
        "201":
          description: Withdrawal requested

  /v1/withdrawals:
    get:
      summary: List withdrawals by role and optional filters
      parameters:
        - in: query
          name: status
          schema:
            type: string
        - in: query
          name: sellerId
          schema:
            type: string
      responses:
        "200":
          description: Withdrawal list

  /v1/withdrawals/{withdrawalId}/approve:
    post:
      summary: Approve pending withdrawal (admin or ops)
      parameters:
        - in: path
          name: withdrawalId
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Withdrawal approved

  /v1/withdrawals/{withdrawalId}/reject:
    post:
      summary: Reject pending withdrawal (admin or ops)
      parameters:
        - in: path
          name: withdrawalId
          required: true
          schema:
            type: string
      responses:
        "202":
          description: Withdrawal rejected

  /v1/chat/threads:
    post:
      summary: Create buyer-seller chat thread
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChatThreadRequest'
      responses:
        "201":
          description: Chat thread created
    get:
      summary: List chat threads visible to current actor
      parameters:
        - in: query
          name: status
          schema:
            type: string
      responses:
        "200":
          description: Chat thread list

  /v1/chat/threads/{threadId}/messages:
    get:
      summary: List chat messages in a thread
      parameters:
        - in: path
          name: threadId
          required: true
          schema:
            type: string
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        "200":
          description: Chat messages
    post:
      summary: Send chat message
      parameters:
        - in: path
          name: threadId
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChatMessageRequest'
      responses:
        "201":
          description: Message created

  /v1/moderation/screen:
    post:
      summary: Screen text/image metadata
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [entityType, entityId]
              properties:
                entityType:
                  type: string
                  enum: [listing, chat_message, profile]
                entityId:
                  type: string
                text:
                  type: string
      responses:
        "200":
          description: Moderation score result

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    CreateListingRequest:
      type: object
      required: [sellerId, title, price, currency]
      properties:
        sellerId:
          type: string
        title:
          type: string
          maxLength: 120
        description:
          type: string
          maxLength: 4000
        price:
          type: number
        currency:
          type: string
          minLength: 3
          maxLength: 3
        tags:
          type: array
          items:
            type: string

    CreateOrderRequest:
      type: object
      required: [buyerId, listingId, currency]
      properties:
        buyerId:
          type: string
        listingId:
          type: string
        currency:
          type: string
          minLength: 3
          maxLength: 3
        expectedTotalCharged:
          type: number
        sellerCommissionRate:
          type: number
          minimum: 0
          maximum: 1
        billingDescriptor:
          type: string
          description: Credit card statement descriptor shown to buyer
        ipAddress:
          type: string
        deviceFingerprint:
          type: string
        avsResult:
          type: string
        cvvResult:
          type: string

    PaymentWebhookRequest:
      type: object
      required: [eventId, orderId, paymentStatus]
      properties:
        eventId:
          type: string
        orderId:
          type: string
        paymentStatus:
          type: string
          enum: [paid, failed, chargeback]
        eventCreatedAt:
          description: Optional event creation timestamp used for replay-window validation
          oneOf:
            - type: integer
            - type: string
        timestamp:
          description: Optional alias for eventCreatedAt
          oneOf:
            - type: integer
            - type: string
        pspTxnId:
          type: string
        failureReason:
          type: string

    CreateDisputeRequest:
      type: object
      required: [orderId, reason]
      properties:
        orderId:
          type: string
        reason:
          type: string
        evidenceUrls:
          type: array
          items:
            type: string
            format: uri

    ResolveDisputeRequest:
      type: object
      required: [outcome]
      properties:
        outcome:
          type: string
          enum: [seller_won, seller_lost]
        note:
          type: string

    ShippingProofRequest:
      type: object
      required: [trackingNumber]
      properties:
        carrier:
          type: string
        trackingNumber:
          type: string
        proofUrl:
          type: string
          format: uri
        markedDeliveredAt:
          type: string
          format: date-time

    ModerationDecisionRequest:
      type: object
      required: [action]
      properties:
        action:
          type: string
          enum: [approve, reject]
        reason:
          type: string

    PurchasePromotionRequest:
      type: object
      required: [sellerId, listingId, planId, currency]
      properties:
        sellerId:
          type: string
        listingId:
          type: string
        planId:
          type: string
        currency:
          type: string
          minLength: 3
          maxLength: 3

    CreateWithdrawalRequest:
      type: object
      required: [amount, currency, payoutMethod]
      properties:
        amount:
          type: number
        currency:
          type: string
          minLength: 3
          maxLength: 3
        payoutMethod:
          type: string
        note:
          type: string

    CreateChatThreadRequest:
      type: object
      required: [buyerId, sellerId]
      properties:
        buyerId:
          type: string
        sellerId:
          type: string
        orderId:
          type: string
        listingId:
          type: string

    CreateChatMessageRequest:
      type: object
      required: [senderId]
      properties:
        senderId:
          type: string
        text:
          type: string
          maxLength: 4000
        imageUrl:
          type: string
          format: uri
